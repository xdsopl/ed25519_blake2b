<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Crypto Module</title>
</head>
<body>
<script>
function print_hex(name, buffer, length) {
	let str = name + ": ";
	for (let i = 0; i < length; ++i)
		str += buffer[i].toString(16).padStart(2, '0').toUpperCase();
	document.getElementById("output").innerHTML += str + "<br />";
}
WebAssembly.instantiateStreaming(fetch("crypto.wasm"))
	.then(obj => {
		document.body.style.color = "white";
		document.body.style.backgroundColor = "black";
		let output = document.getElementById("output");
		const wasm = obj.instance.exports;
		buffer = wasm.memory.buffer;
		//console.log(wasm);
		let start = performance.now();
		let keypair = new Uint8Array(buffer, wasm.keypair, 64);
		self.crypto.getRandomValues(keypair);
		let end = performance.now();
		output.innerHTML += "getRandomValues: " + (end - start).toFixed(2) + " ms<br />";
		print_hex("Random Bytes", keypair, 32);
		start = performance.now();
		wasm.create_keypair();
		end = performance.now();
		output.innerHTML += "create_keypair: " + (end - start).toFixed(2) + " ms<br />";
		print_hex("Key Pair", keypair, 64);
		let message_length = 42;
		let signed_length = message_length + 64;
		let message = new Uint8Array(buffer, wasm.message, signed_length);
		for (let i = 0; i < message_length; ++i)
			message[i] = Math.trunc(Math.random() * 256);
		print_hex("Message", message, message_length);
		start = performance.now();
		wasm.sign_message(message_length);
		end = performance.now();
		output.innerHTML += "sign_message: " + (end - start).toFixed(2) + " ms<br />";
		print_hex("Signed", message, signed_length);
		//message[Math.trunc(Math.random() * signed_length)] ^= 1 << Math.trunc(Math.random() * 8);
		start = performance.now();
		if (wasm.open_message(signed_length) < 0)
			output.innerHTML += "Verification failed!<br />";
		end = performance.now();
		output.innerHTML += "open_message: " + (end - start).toFixed(2) + " ms<br />";
		print_hex("Message", message, message_length);
	});
</script>
<p>
<h1>Playing with Ed25519 and BLAKE2b</h1>
WebAssembly crypto module for digital signing based on Ed25519 and BLAKE2B<br />
Copyright 2024 Ahmet Inan &lt;xdsopl@gmail.com&gt;<br />
</p>
<p id="output"></p>
</body>
</html>
